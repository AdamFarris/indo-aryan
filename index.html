<!DOCTYPE html>
<html>
    <head>
        <!-- CSS only -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
        <!-- JavaScript Bundle with Popper -->
        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
        <script src="https://d3js.org/d3.v6.min.js"></script>
        <script src="https://unpkg.com/topojson@3"></script>
        <style>
            html, body {margin: 0; height: 100%; overflow: hidden}
        </style>
    </head>
    <body>
        <div style="position: absolute; left: 30px; top: 30px; max-width: 400px;" class="card bg-dark text-white shadow">
            <div class="card-body">
                <h3 class="card-title name">Hover over/click a dot.</h3>
            </div>
        </div>
        <svg id="map"></svg>
    </body>
    <script>
        var width = window.innerWidth, height = window.innerHeight

        var svg = d3.select("#map")
            .attr("preserveAspectRatio", "xMidYMid")
            .attr("viewBox", "0 0 " + width + " " + height)
        var g = svg.append("g")

        var projection = d3.geoEqualEarth()
            .scale(1000)
            .center([60, 20])
            .translate([width / 2, height / 2])

        var path = d3.geoPath()
            .projection(projection)

        var scale = 1
        function zoomed(event) {
            g.attr("transform", event.transform)
            scale = event.transform.k
            d3.selectAll(".city")
                .attr("r", 2.5 / event.transform.k)
        }
        function unzoomed() {
            svg.transition().duration(1000).call(
                zoom.transform,
                d3.zoomIdentity,
                d3.zoomTransform(svg.node()).invert([width / 2, height / 2])
            )
        }
        var zoom = d3.zoom()
            .extent([[0, 0], [width, height]])
            .scaleExtent([1, 12])
            .on("zoom", zoomed)
        svg.call(zoom)

        Promise.all([
            d3.json("coords.json"),
            d3.json("refs.json"), 
            d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/land-50m.json")
        ]).then(function(files) {
            load(files[0], files[1], files[2])
        })
        
        function load(coord, ref, world) {
            topo = topojson.feature(world, world.objects.land).features
            g.selectAll("path")
                .data(topo)
                .enter()
                .append("path")
                    .attr("id", "land")
                    .attr("d", path)
                    .attr("fill", "#EEE")
                    .attr("stroke", "black")
                    .attr("stroke-width", 0.2)
            
            var clicked = null
            langs = {}
            refs = {}
            cities = {}
            subcities = {}
            ref.forEach(d => {
                for (lang in d.languages) {
                    if (!(lang in langs)) langs[lang] = []
                    d.languages[lang].forEach(city => {
                        if (!(city in cities)) cities[city] = 0
                        cities[city]++
                        langs[lang].push(coord.cities[city])
                    })

                    if (!(lang in refs)) refs[lang] = []
                    refs[lang].push(d)

                    if (!(lang in subcities)) subcities[lang] = {}
                    d.languages[lang].forEach(city => {
                        if (!(city in subcities[lang])) subcities[lang][city] = 0
                        subcities[lang][city]++
                    })
                }
            });

            var lines = g.append("g")
            var subg = g.append("g")
            
            var stored_coords = {}
            for (lang in langs) {
                var loc = projection([d3.mean(langs[lang], d => d[1]), d3.mean(langs[lang], d => d[0])])
                stored_coords[lang] = loc
                var r = Math.sqrt(refs[lang].length) * 3
                var x = g.append("circle")
                    .attr("cx", loc[0])
                    .attr("cy", loc[1])
                    .attr("r", r)
                    .attr("fill", "white")
                    .attr("id", lang)
                    .attr("stroke", "black")

                x.on("mouseover", function(event, d) {
                    var l = d3.select(this).attr("id")
                    var loc = stored_coords[l]
                    var r = Math.sqrt(refs[l].length) * 3

                    g.append("text")
                        .attr("x", loc[0] + r)
                        .attr("y", loc[1] - r)
                        .style("opacity", 0)
                        .text(l)
                        .transition()
                        .style("opacity", null)
                })

                x.on("mouseout", function(event, d) {
                    d3.selectAll("text").transition().style("opacity", 0).remove()
                })
                    
                x.on("click", function(event, d) {
                    var l = d3.select(this).attr("id")
                    if (clicked != l) {
                        if (clicked != null) {
                            d3.selectAll(".card-text").remove()
                            d3.select(".name").text("Hover over/click a dot.")
                            subg.selectAll("*").transition().attr("r", 0).remove()
                            lines.selectAll("*")
                                .transition()
                                .attr("x1", stored_coords[l][0])
                                .attr("y1", stored_coords[l][1])
                                .remove()
                        }
                        d3.selectAll("circle")
                            .style("opacity", 0.3)
                        clicked = l
                        var board = d3.select(".card-body")
                        d3.select(".name").text(l)
                        board.append("p")
                            .attr("class", "card-text")
                            .html(refs[l].length + " source(s) covering " + langs[l].length + " location(s).")
                        board = board.append("ul")
                            .attr("class", "card-text")
                        refs[l].forEach(x => {
                            var note = `${x.author.join(', ')} (${x.year}). <em>${x.title}</em>.`
                            x.languages[l].forEach(city => {
                                note += ` <span class="badge bg-secondary">${city}</span>`
                            })
                            if (x.url) note += ` <a href="${x.url}">link</a>`
                            board.append("li")
                                .html(note)
                        })
                        for (city in subcities[l]) {
                            var loc2 = projection([coord.cities[city][1], coord.cities[city][0]])
                            var r = Math.sqrt(subcities[l][city]) * 3
                            subg.append("circle")
                                .attr("cx", loc2[0])
                                .attr("cy", loc2[1])
                                .transition()
                                .attr("r", r)
                                .attr("fill", "steelblue")
                                .attr("stroke", "black")
                            lines.append("line")
                                .attr("x2", stored_coords[l][0])
                                .attr("y2", stored_coords[l][1])
                                .attr("x1", stored_coords[l][0])
                                .attr("y1", stored_coords[l][1])
                                .transition()
                                .attr("x1", loc2[0])
                                .attr("y1", loc2[1])
                                .attr("stroke", "black")
                        }
                    }
                    else {
                        clicked = null
                        d3.selectAll("circle")
                            .style("opacity", null)
                        d3.selectAll(".card-text").remove()
                        d3.select(".name").text("Hover over/click a dot.")
                        subg.selectAll("*").transition().attr("r", 0).remove()
                        lines.selectAll("*")
                            .transition()
                            .attr("x1", stored_coords[l][0])
                            .attr("y1", stored_coords[l][1])
                            .remove()
                    }
                })
            }
        }
    </script>
</html>